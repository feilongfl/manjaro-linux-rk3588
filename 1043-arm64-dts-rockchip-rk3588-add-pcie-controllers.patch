
Workarrounds in 

diff --speed-large-files --no-dereference --minimal -Naur linux-6.2/arch/arm64/boot/dts/rockchip/rk3588.dtsi linux-6.2/arch/arm64/boot/dts/rockchip/rk3588.dtsi
--- linux-6.2/arch/arm64/boot/dts/rockchip/rk3588.dtsi	2023-02-21 15:46:25.426534346 +0100
+++ linux-6.2/arch/arm64/boot/dts/rockchip/rk3588.dtsi	2023-02-21 15:39:27.639882917 +0100
@@ -4,9 +4,9 @@
  */
 
 #include "rk3588s.dtsi"
-#include "rk3588-pinctrl.dtsi"
 
 / {
+	compatible = "rockchip,rk3588";
 
 	aliases {
 		mmc0 = &sdhci;
@@ -113,19 +113,19 @@
 		linux,pci-domain = <0>;
 		num-ib-windows = <16>;
 		num-ob-windows = <16>;
-		num-viewport = <8>;
 		max-link-speed = <3>;
 		msi-map = <0x0000 &its1 0x0000 0x1000>;
 		num-lanes = <4>;
 		phys = <&pcie30phy>;
 		phy-names = "pcie-phy";
 		power-domains = <&power RK3588_PD_PCIE>;
-		ranges = <0x01000000 0x0 0x3ef00000 0x9 0x3ef00000 0x0 0x00100000>,
-			 <0x02000000 0x0 0x00000000 0x9 0x00000000 0x0 0x3ef00000>;
-		reg = <0x0 0xfe150000 0x0 0x00010000>,
-		      <0xa 0x40000000 0x0 0x00400000>,
-		      <0x9 0x3f000000 0x0 0x01000000>;
-		reg-names = "apb", "dbi", "config";
+		ranges = <0x01000000 0x0 0xf0100000 0x0 0xf0100000 0x0 0x00100000>,
+			 <0x02000000 0x9 0xf0200000 0x0 0xf0200000 0x0 0x00e00000>,
+			 <0x03000000 0x9 0x00000000 0x9 0x00000000 0x0 0x40000000>;
+		reg = <0xa 0x40000000 0x0 0x00400000>,
+		      <0x0 0xfe150000 0x0 0x00010000>,
+		      <0x0 0xf0000000 0x0 0x00100000>;
+		reg-names = "dbi", "apb", "config";
 		resets = <&cru SRST_PCIE0_POWER_UP>, <&cru SRST_P_PCIE0>;
 		reset-names = "pcie", "periph";
 		rockchip,pipe-grf = <&php_grf>;
@@ -167,19 +167,19 @@
 		linux,pci-domain = <1>;
 		num-ib-windows = <16>;
 		num-ob-windows = <16>;
-		num-viewport = <8>;
 		max-link-speed = <3>;
 		msi-map = <0x1000 &its1 0x1000 0x1000>;
 		num-lanes = <2>;
 		phys = <&pcie30phy>;
 		phy-names = "pcie-phy";
 		power-domains = <&power RK3588_PD_PCIE>;
-		ranges = <0x01000000 0x0 0x3ef00000 0x9 0x7ef00000 0x0 0x00100000>,
-			 <0x02000000 0x0 0x00000000 0x9 0x40000000 0x0 0x3ef00000>;
-		reg = <0x0 0xfe160000 0x0 0x00010000>,
-		      <0xa 0x40400000 0x0 0x00400000>,
-		      <0x9 0x7f000000 0x0 0x01000000>;
-		reg-names = "apb", "dbi", "config";
+		ranges = <0x01000000 0x0 0xf1100000 0x0 0xf1100000 0x0 0x00100000>,
+			 <0x02000000 0x0 0xf1200000 0x0 0xf1200000 0x0 0x00e00000>,
+			 <0x03000000 0x9 0x40000000 0x9 0x40000000 0x0 0x40000000>;
+		reg = <0xa 0x40400000 0x0 0x00400000>,
+		      <0x0 0xfe160000 0x0 0x00010000>,
+		      <0x0 0xf1000000 0x0 0x00100000>;
+		reg-names = "dbi", "apb", "config";
 		resets = <&cru SRST_PCIE1_POWER_UP>, <&cru SRST_P_PCIE1>;
 		reset-names = "pcie", "periph";
 		rockchip,pipe-grf = <&php_grf>;
@@ -221,18 +221,19 @@
 		linux,pci-domain = <2>;
 		num-ib-windows = <8>;
 		num-ob-windows = <8>;
-		num-viewport = <4>;
 		max-link-speed = <2>;
 		msi-map = <0x2000 &its0 0x2000 0x1000>;
 		num-lanes = <1>;
 		phys = <&combphy1 PHY_TYPE_PCIE>;
 		phy-names = "pcie-phy";
-		ranges = <0x01000000 0x0 0x3ef00000 0x9 0xbef00000 0x0 0x00100000>,
-			 <0x02000000 0x0 0x00000000 0x9 0x80000000 0x0 0x3ef00000>;
-		reg = <0x0 0xfe170000 0x0 0x00010000>,
-		      <0xa 0x40800000 0x0 0x00400000>,
-		      <0x9 0xbf000000 0x0 0x01000000>;
-		reg-names = "apb", "dbi", "config";
+		power-domains = <&power RK3588_PD_PCIE>;
+		ranges = <0x01000000 0x0 0xf2100000 0x0 0xf2100000 0x0 0x00100000>,
+			 <0x02000000 0x0 0xf2200000 0x0 0xf2200000 0x0 0x00e00000>,
+			 <0x03000000 0x9 0x80000000 0x9 0x80000000 0x0 0x40000000>;
+		reg = <0xa 0x40800000 0x0 0x00400000>,
+		      <0x0 0xfe170000 0x0 0x00010000>,
+		      <0x0 0xf2000000 0x0 0x00100000>;
+		reg-names = "dbi", "apb", "config";
 		resets = <&cru SRST_PCIE2_POWER_UP>, <&cru SRST_P_PCIE2>;
 		reset-names = "pcie", "periph";
 		rockchip,pipe-grf = <&php_grf>;
@@ -333,7 +334,7 @@
 		#phy-cells = <1>;
 		clocks = <&cru CLK_REF_PIPE_PHY1>, <&cru PCLK_PCIE_COMBO_PIPE_PHY1>,
 			 <&cru PCLK_PHP_ROOT>;
-		clock-names = "refclk", "apbclk", "phpclk";
+		clock-names = "ref", "apb", "pipe";
 		assigned-clocks = <&cru CLK_REF_PIPE_PHY1>;
 		assigned-clock-rates = <100000000>;
 		resets = <&cru SRST_P_PCIE2_PHY1>, <&cru SRST_REF_PIPE_PHY1>;
@@ -416,3 +417,5 @@
 		status = "disabled";
 	};
 };
+
+#include "rk3588-pinctrl.dtsi"
diff --speed-large-files --no-dereference --minimal -Naur linux-6.2/arch/arm64/boot/dts/rockchip/rk3588s.dtsi linux-6.2/arch/arm64/boot/dts/rockchip/rk3588s.dtsi
--- linux-6.2/arch/arm64/boot/dts/rockchip/rk3588s.dtsi	2023-02-21 15:46:25.426534346 +0100
+++ linux-6.2/arch/arm64/boot/dts/rockchip/rk3588s.dtsi	2023-02-21 15:44:55.953204300 +0100
@@ -12,7 +12,7 @@
 #include <dt-bindings/thermal/thermal.h>
 
 / {
-	compatible = "rockchip,rk3588";
+	compatible = "rockchip,rk3588s";
 
 	interrupt-parent = <&gic>;
 	#address-cells = <2>;
@@ -1648,7 +1648,7 @@
 	};
 
 	pcie2x1l1: pcie@fe180000 {
-		compatible = "rockchip,rk3588-pcie", "snps,dw-pcie";
+		compatible = "rockchip,rk3588-pcie";
 		#address-cells = <3>;
 		#size-cells = <2>;
 		bus-range = <0x30 0x3f>;
@@ -1674,19 +1674,19 @@
 		linux,pci-domain = <3>;
 		num-ib-windows = <8>;
 		num-ob-windows = <8>;
-		num-viewport = <4>;
 		max-link-speed = <2>;
 		msi-map = <0x3000 &its0 0x3000 0x1000>;
 		num-lanes = <1>;
 		phys = <&combphy2 PHY_TYPE_PCIE>;
 		phy-names = "pcie-phy";
-		ranges = <0x00000800 0x0 0xf3000000 0x0 0xf3000000 0x0 0x100000
-			  0x81000000 0x0 0xf3100000 0x0 0xf3100000 0x0 0x100000
-			  0x82000000 0x0 0xf3200000 0x0 0xf3200000 0x0 0xe00000
-			  0xc3000000 0x9 0xc0000000 0x9 0xc0000000 0x0 0x40000000>;
-		reg = <0x0 0xfe180000 0x0 0x10000>,
-		      <0xa 0x40c00000 0x0 0x400000>;
-		reg-names = "pcie-apb", "pcie-dbi";
+		power-domains = <&power RK3588_PD_PCIE>;
+		ranges = <0x01000000 0x0 0xf3100000 0x0 0xf3100000 0x0 0x00100000>,
+			 <0x02000000 0x0 0xf3200000 0x0 0xf3200000 0x0 0x00e00000>,
+			 <0x03000000 0x9 0xc0000000 0x9 0xc0000000 0x0 0x40000000>;
+		reg = <0x0 0xfe180000 0x0 0x00010000>,
+		      <0xa 0x40c00000 0x0 0x00400000>,
+		      <0x0 0xf3000000 0x0 0x00100000>;
+		reg-names = "apb", "dbi", "config";
 		resets = <&cru SRST_PCIE3_POWER_UP>, <&cru SRST_P_PCIE3>;
 		reset-names = "pcie", "periph";
 		rockchip,pipe-grf = <&php_grf>;
@@ -1728,19 +1728,19 @@
 		linux,pci-domain = <4>;
 		num-ib-windows = <8>;
 		num-ob-windows = <8>;
-		num-viewport = <4>;
 		max-link-speed = <2>;
 		msi-map = <0x4000 &its0 0x4000 0x1000>;
 		num-lanes = <1>;
 		phys = <&combphy0 PHY_TYPE_PCIE>;
 		phy-names = "pcie-phy";
-		ranges = <0x00000800 0x0 0xf4000000 0x0 0xf4000000 0x0 0x100000
-			  0x81000000 0x0 0xf4100000 0x0 0xf4100000 0x0 0x100000
-			  0x82000000 0x0 0xf4200000 0x0 0xf4200000 0x0 0xe00000
-			  0xc3000000 0xa 0x00000000 0xa 0x00000000 0x0 0x40000000>;
-		reg = <0x0 0xfe190000 0x0 0x10000>,
-		      <0xa 0x41000000 0x0 0x400000>;
-		reg-names = "pcie-apb", "pcie-dbi";
+		power-domains = <&power RK3588_PD_PCIE>;
+		ranges = <0x01000000 0x0 0xf4100000 0x0 0xf4100000 0x0 0x00100000>,
+			 <0x02000000 0x0 0xf4200000 0x0 0xf4200000 0x0 0x00e00000>,
+			 <0x03000000 0xa 0x00000000 0xa 0x00000000 0x0 0x40000000>;
+		reg = <0xa 0x41000000 0x0 0x00400000>,
+		      <0x0 0xfe190000 0x0 0x00010000>,
+		      <0x0 0xf4000000 0x0 0x00100000>;
+		reg-names = "dbi", "apb", "config";
 		resets = <&cru SRST_PCIE4_POWER_UP>, <&cru SRST_P_PCIE4>;
 		reset-names = "pcie", "periph";
 		rockchip,pipe-grf = <&php_grf>;
@@ -1837,24 +1837,47 @@
 		status = "disabled";
 	};
 
+	iommu_pcie: iommu@fc900000 {
+		compatible = "arm,smmu-v3";
+		reg = <0x0 0xfc900000 0x0 0x200000>;
+		interrupts = <GIC_SPI 369 IRQ_TYPE_LEVEL_HIGH 0>,
+			     <GIC_SPI 371 IRQ_TYPE_LEVEL_HIGH 0>,
+			     <GIC_SPI 374 IRQ_TYPE_LEVEL_HIGH 0>,
+			     <GIC_SPI 367 IRQ_TYPE_LEVEL_HIGH 0>;
+		interrupt-names = "eventq", "gerror", "priq", "cmdq-sync";
+		#iommu-cells = <1>;
+		status = "disabled";
+	};
+
+	iommu_php: iommu@fcb00000 {
+		compatible = "arm,smmu-v3";
+		reg = <0x0 0xfcb00000 0x0 0x200000>;
+		interrupts = <GIC_SPI 381 IRQ_TYPE_LEVEL_HIGH 0>,
+			     <GIC_SPI 383 IRQ_TYPE_LEVEL_HIGH 0>,
+			     <GIC_SPI 386 IRQ_TYPE_LEVEL_HIGH 0>,
+			     <GIC_SPI 379 IRQ_TYPE_LEVEL_HIGH 0>;
+		interrupt-names = "eventq", "gerror", "priq", "cmdq-sync";
+		#iommu-cells = <1>;
+		status = "disabled";
+	};
+
 	gic: interrupt-controller@fe600000 {
 		compatible = "arm,gic-v3";
-		reg = <0x0 0xfe600000 0 0x10000>, /* GICD */
+		reg = <0x0 0xfe600000 0 0x010000>, /* GICD */
 		      <0x0 0xfe680000 0 0x100000>; /* GICR */
 		interrupts = <GIC_PPI 9 IRQ_TYPE_LEVEL_HIGH 0>;
 		interrupt-controller;
 		#interrupt-cells = <4>;
 		#address-cells = <2>;
 		#size-cells = <2>;
-		mbi-alias = <0x0 0xfe610000>;
-		mbi-ranges = <424 56>;
-		msi-controller;
+		ranges;
 
 		its0: msi-controller@fe640000 {
 			compatible = "arm,gic-v3-its";
 			msi-controller;
 			#msi-cells = <1>;
 			reg = <0x0 0xfe640000 0x0 0x20000>;
+			power-domains = <&power RK3588_PD_PCIE>;
 		};
 
 		its1: msi-controller@fe660000 {
@@ -1862,6 +1885,7 @@
 			msi-controller;
 			#msi-cells = <1>;
 			reg = <0x0 0xfe660000 0x0 0x20000>;
+			power-domains = <&power RK3588_PD_PCIE>;
 		};
 
 		ppi-partitions {
diff --git a/arch/arm64/boot/dts/rockchip/rk3588.dtsi b/arch/arm64/boot/dts/rockchip/rk3588.dtsi
index adc6864663f..9aa2c40513f 100644
--- a/arch/arm64/boot/dts/rockchip/rk3588.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3588.dtsi
@@ -122,7 +122,7 @@ pcie3x4: pcie@fe150000 {
 		phy-names = "pcie-phy";
 		power-domains = <&power RK3588_PD_PCIE>;
 		ranges = <0x01000000 0x0 0xf0100000 0x0 0xf0100000 0x0 0x00100000>,
-			 <0x02000000 0x9 0xf0200000 0x0 0xf0200000 0x0 0x00e00000>,
+			 <0x02000000 0x0 0xf0200000 0x0 0xf0200000 0x0 0x00e00000>,
 			 <0x03000000 0x9 0x00000000 0x9 0x00000000 0x0 0x40000000>;
 		reg = <0xa 0x40000000 0x0 0x00400000>,
 		      <0x0 0xfe150000 0x0 0x00010000>,
-- 
2.36.1

